---
// src/pages/blog/[...slug].astro

import type { GetStaticPaths } from 'astro';
import type { CollectionEntry } from 'astro:content';
import { getCollection } from 'astro:content';
import { dirname } from 'node:path';
import Layout from '../../layouts/main/Layout.astro';
import Carousel from '../../components/carousel/Carousel.astro'; 
import '../../styles/blogpost.scss';

export const prerender = true;

const allImages = import.meta.glob<{ default: ImageMetadata }>('/src/content/blog/**/*.{jpeg,jpg,png,webp,svg}');

// ðŸš€ Ahora usamos folder/archivo en el slug
// src/pages/blog/[...slug].astro

export const getStaticPaths: GetStaticPaths = async () => {
  const entries = await getCollection("blog");

  return entries.map((entry) => {
    const [folder, fileWithExt] = entry.id.split("/");
    const file = fileWithExt.replace(/\.(md|mdx)$/, "");

    return {
      params: { slug: `${folder}/${file}` }, // ðŸ‘ˆ string, no array
      props: { entry },
    };
  });
};


interface Props {
  entry: CollectionEntry<'blog'>;
}

const { entry } = Astro.props;
const { Content } = await entry.render();

const postDir = dirname(entry.id);
const filterPath = `/src/content/blog/${postDir}/`;
const imagePromises = Object.entries(allImages)
  .filter(([path]) => path.startsWith(filterPath))
  .map(([, importer]) => importer());
const currentPostImages = (await Promise.all(imagePromises)).map((mod) => mod.default);

const displayUrl = entry.data.externalUrl 
  ? new URL(entry.data.externalUrl).hostname.replace(/^www\./, '') 
  : '';
---

<Layout title={entry.data.title} description={entry.data.description}>
  <article class="blog-post">
    <div class="post-column-visual">
      {currentPostImages.length > 0 ? (
        <Carousel images={currentPostImages} />
      ) : (
        <p>No se encontraron imÃ¡genes para este post.</p>
      )}

      <div class="tags-container">
        <h3>ETIQUETAS</h3>
        <ul class="tags-list">
          {entry.data.tags.map(tag => (
            <li><a href={`/${tag.toLowerCase()}`}>{tag.toUpperCase()}</a></li>
          ))}
        </ul>
      </div>

      {entry.data.externalUrl && (
        <div class="visit-link-container">
          <a href={entry.data.externalUrl} class="visit-button" target="_blank" rel="noopener noreferrer">
            Visitar {displayUrl}
          </a>
        </div>
      )}

      <div class="back-button-container">
        <button class="back-button" onclick="history.back()">Regresar</button>
      </div>
    </div>

    <div class="post-column-text">
      <header class="post-header">
        <h1 class="post-title">{entry.data.title}</h1>
        <div class="post-meta">
          <span>Por: {entry.data.author}</span>
          <span>
            Publicado:
            <time datetime={entry.data.pubDate.toISOString()}>
              {new Date(entry.data.pubDate).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' })}
            </time>
          </span>
        </div>
      </header>

      <div class="post-content">
        <Content />
      </div>
    </div>
  </article>
</Layout>
